<script>
	import { Resizer, ResizableColumn, CodeEditor, StructureDrawing } from '../lib'
	import { parseStructure } from '../services/parse.js'
	import { solveStructure } from '../services/solve.js'

	let lines = $state([
		'# Warren truss with 20 spans',
		'',
		'nodes',
		'# lower nodes',
		'1: (0.0, 0.0) (xy)',
		'2: (200.0, 0.0) ()',
		'3: (400.0, 0.0) ()',
		'4: (600.0, 0.0) ()',
		'5: (800.0, 0.0) ()',
		'6: (1000.0, 0.0) ()',
		'7: (1200.0, 0.0) ()',
		'8: (1400.0, 0.0) ()',
		'9: (1600.0, 0.0) ()',
		'10: (1800.0, 0.0) ()',
		'11: (2000.0, 0.0) ()',
		'12: (2200.0, 0.0) ()',
		'13: (2400.0, 0.0) ()',
		'14: (2600.0, 0.0) ()',
		'15: (2800.0, 0.0) ()',
		'16: (3000.0, 0.0) ()',
		'17: (3200.0, 0.0) ()',
		'18: (3400.0, 0.0) ()',
		'19: (3600.0, 0.0) ()',
		'20: (3800.0, 0.0) ()',
		'21: (4000.0, 0.0) (y)',
		'# upper nodes',
		'22: (200.0, 300.0) ()',
		'23: (400.0, 300.0) ()',
		'24: (600.0, 300.0) ()',
		'25: (800.0, 300.0) ()',
		'26: (1000.0, 300.0) ()',
		'27: (1200.0, 300.0) ()',
		'28: (1400.0, 300.0) ()',
		'29: (1600.0, 300.0) ()',
		'30: (1800.0, 300.0) ()',
		'31: (2000.0, 300.0) ()',
		'32: (2200.0, 300.0) ()',
		'33: (2400.0, 300.0) ()',
		'34: (2600.0, 300.0) ()',
		'35: (2800.0, 300.0) ()',
		'36: (3000.0, 300.0) ()',
		'37: (3200.0, 300.0) ()',
		'38: (3400.0, 300.0) ()',
		'39: (3600.0, 300.0) ()',
		'40: (3800.0, 300.0) ()',
		'',
		'loads',
		'2 -> (1000.0, -3500.0)',
		'3 -> (1000.0, -3500.0)',
		'4 -> (1000.0, -3500.0)',
		'5 -> (1000.0, -3500.0)',
		'6 -> (1000.0, -3500.0)',
		'7 -> (1000.0, -3500.0)',
		'8 -> (1000.0, -3500.0)',
		'9 -> (1000.0, -3500.0)',
		'10 -> (1000.0, -3500.0)',
		'11 -> (1000.0, -3500.0)',
		'12 -> (1000.0, -3500.0)',
		'13 -> (1000.0, -3500.0)',
		'14 -> (1000.0, -3500.0)',
		'15 -> (1000.0, -3500.0)',
		'16 -> (1000.0, -3500.0)',
		'17 -> (1000.0, -3500.0)',
		'18 -> (1000.0, -3500.0)',
		'19 -> (1000.0, -3500.0)',
		'20 -> (1000.0, -3500.0)',
		'22 -> (1000.0, -3500.0)',
		'23 -> (1000.0, -3500.0)',
		'24 -> (1000.0, -3500.0)',
		'25 -> (1000.0, -3500.0)',
		'26 -> (1000.0, -3500.0)',
		'27 -> (1000.0, -3500.0)',
		'28 -> (1000.0, -3500.0)',
		'29 -> (1000.0, -3500.0)',
		'30 -> (1000.0, -3500.0)',
		'31 -> (1000.0, -3500.0)',
		'32 -> (1000.0, -3500.0)',
		'33 -> (1000.0, -3500.0)',
		'34 -> (1000.0, -3500.0)',
		'35 -> (1000.0, -3500.0)',
		'36 -> (1000.0, -3500.0)',
		'37 -> (1000.0, -3500.0)',
		'38 -> (1000.0, -3500.0)',
		'39 -> (1000.0, -3500.0)',
		'40 -> (1000.0, -3500.0)',
		'',
		'bars',
		'# horizontal bars',
		'1: (1 -> 2) 25.0 20000000.0',
		'2: (2 -> 3) 25.0 20000000.0',
		'3: (3 -> 4) 25.0 20000000.0',
		'4: (4 -> 5) 25.0 20000000.0',
		'5: (5 -> 6) 25.0 20000000.0',
		'6: (6 -> 7) 25.0 20000000.0',
		'7: (7 -> 8) 25.0 20000000.0',
		'8: (8 -> 9) 25.0 20000000.0',
		'9: (9 -> 10) 25.0 20000000.0',
		'10: (10 -> 11) 25.0 20000000.0',
		'11: (11 -> 12) 25.0 20000000.0',
		'12: (12 -> 13) 25.0 20000000.0',
		'13: (13 -> 14) 25.0 20000000.0',
		'14: (14 -> 15) 25.0 20000000.0',
		'15: (15 -> 16) 25.0 20000000.0',
		'16: (16 -> 17) 25.0 20000000.0',
		'17: (17 -> 18) 25.0 20000000.0',
		'18: (18 -> 19) 25.0 20000000.0',
		'19: (19 -> 20) 25.0 20000000.0',
		'20: (20 -> 21) 25.0 20000000.0',
		'21: (22 -> 23) 25.0 20000000.0',
		'22: (23 -> 24) 25.0 20000000.0',
		'23: (24 -> 25) 25.0 20000000.0',
		'24: (25 -> 26) 25.0 20000000.0',
		'25: (26 -> 27) 25.0 20000000.0',
		'26: (27 -> 28) 25.0 20000000.0',
		'27: (28 -> 29) 25.0 20000000.0',
		'28: (29 -> 30) 25.0 20000000.0',
		'29: (30 -> 31) 25.0 20000000.0',
		'30: (31 -> 32) 25.0 20000000.0',
		'31: (32 -> 33) 25.0 20000000.0',
		'32: (33 -> 34) 25.0 20000000.0',
		'33: (34 -> 35) 25.0 20000000.0',
		'34: (35 -> 36) 25.0 20000000.0',
		'35: (36 -> 37) 25.0 20000000.0',
		'36: (37 -> 38) 25.0 20000000.0',
		'37: (38 -> 39) 25.0 20000000.0',
		'38: (39 -> 40) 25.0 20000000.0',
		'# vertical bars',
		'39: (2 -> 22) 25.0 20000000.0',
		'40: (3 -> 23) 25.0 20000000.0',
		'41: (4 -> 24) 25.0 20000000.0',
		'42: (5 -> 25) 25.0 20000000.0',
		'43: (6 -> 26) 25.0 20000000.0',
		'44: (7 -> 27) 25.0 20000000.0',
		'45: (8 -> 28) 25.0 20000000.0',
		'46: (9 -> 29) 25.0 20000000.0',
		'47: (10 -> 30) 25.0 20000000.0',
		'48: (11 -> 31) 25.0 20000000.0',
		'49: (12 -> 32) 25.0 20000000.0',
		'50: (13 -> 33) 25.0 20000000.0',
		'51: (14 -> 34) 25.0 20000000.0',
		'52: (15 -> 35) 25.0 20000000.0',
		'53: (16 -> 36) 25.0 20000000.0',
		'54: (17 -> 37) 25.0 20000000.0',
		'55: (18 -> 38) 25.0 20000000.0',
		'56: (19 -> 39) 25.0 20000000.0',
		'57: (20 -> 40) 25.0 20000000.0',
		'# diagonal bars',
		'58: (1 -> 22) 25.0 20000000.0',
		'59: (22 -> 3) 25.0 20000000.0',
		'60: (3 -> 24) 25.0 20000000.0',
		'61: (24 -> 5) 25.0 20000000.0',
		'62: (5 -> 26) 25.0 20000000.0',
		'63: (26 -> 7) 25.0 20000000.0',
		'64: (7 -> 28) 25.0 20000000.0',
		'65: (28 -> 9) 25.0 20000000.0',
		'66: (9 -> 30) 25.0 20000000.0',
		'67: (30 -> 11) 25.0 20000000.0',
		'68: (11 -> 32) 25.0 20000000.0',
		'69: (32 -> 13) 25.0 20000000.0',
		'70: (13 -> 34) 25.0 20000000.0',
		'71: (34 -> 15) 25.0 20000000.0',
		'72: (15 -> 36) 25.0 20000000.0',
		'73: (36 -> 17) 25.0 20000000.0',
		'74: (17 -> 38) 25.0 20000000.0',
		'75: (38 -> 19) 25.0 20000000.0',
		'76: (19 -> 40) 25.0 20000000.0',
		'77: (40 -> 21) 25.0 20000000.0'
	])

	let structure = $state({ nodes: [], bars: [] })
	let errors = $state([])
	$inspect(errors)
	let solution = $state(null)
	$effect(() => {
		const { structure: parsedStructure, errors: parseErrors } = parseStructure(lines)
		structure = parsedStructure
		errors = parseErrors
	})

	async function handleSolveStructure() {
		// TODO: try-catch errors
		solution = await solveStructure(structure, lines)
	}
</script>

<header>
	<h2>2D Truss Structures</h2>
	<button onclick={handleSolveStructure}>Calculate</button>
</header>
<main>
	<ResizableColumn widthPercentage="25">
		<CodeEditor bind:lines {errors} />
	</ResizableColumn>
	<Resizer />
	<ResizableColumn widthPercentage="75">
		<StructureDrawing {structure} {solution} />
	</ResizableColumn>
</main>

<style>
	header {
		background-color: var(--main-color);
		padding: 1em;
		display: flex;

		> h2 {
			margin: 0;
		}
	}

	main {
		display: flex;
		flex-grow: 1;
		overflow: hidden;
	}
</style>
